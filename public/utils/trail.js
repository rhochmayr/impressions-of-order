class Trail{constructor(t,s,i,h){this.p=t,this.v=s,this.ix=i,this.points=[],this.edges=[],this.ss=[],this.co=[],this.sM=r(.1,.6),this.aM=r(.4,1),this.cM=r(.2,.5),this.ms=r(1)<.9?r(9,15):r(15,45),this.mf=r(6,10),this.roi=r(1)<1.9?r(10,150):pr(50,100),this.sRo=this.roi*r(.2,.7),this.bounce=r(1)<.5,this.sep=createVector(0,0),this.ali=createVector(0,0),this.coh=createVector(0,0),this.cc=h,this.zoom=r(1),this.ori=r(1),this.bsize=r(1),this.loadCol()}loadCol(){let t=this.bsize<ft.dotThresh,s=this.ori<ft.ori,i=1;s&&(i=0),s||1!=t||(i=2),this.cc=pal.getCol(i)}run(t,s){this.genVectors(t);let i=this.borders();this.points[s]={cp:this.p.copy(),cv:this.v.copy(),tela:i}}drawEdges(){sh.strokeWeight(.5);let t=red(this.cc),s=green(this.cc),i=blue(this.cc);for(let h of this.edges)sh.stroke(t,s,i,10),sh.line(h.p1.x,h.p1.y,h.p2.x,h.p2.y),sh.stroke(255,20),sh.line(h.p1.x,h.p1.y+1,h.p2.x,h.p2.y+1)}extendPoints(){for(let t=0;t<this.points.length-1;t++){let s=p5.Vector.fromAngle(this.points[t].cv.heading()+PI/2),i=t/ft.sFlat,h=constrain(this.points[t].cp.x-s.x*i,bord.minX,bord.maxX),e=(ft.rot,constrain(this.points[t].cp.y-s.y*i,bord.minY,bord.maxY));this.points[t].ex=createVector(h,e)}}getHeading(t,s,i,h){let e=this.points[t].cv.heading()+PI/2,o=abs(e-s);return constrain(map(o,0,i,h,0),0,h)}drawOutline(){sh.strokeWeight(1);for(let t=0;t<this.points.length-3;t++)0==this.points[t+1].tela&&this.outline(t,t+1)}outline(t,s){let i=this.points[t].ex,h=this.points[s].ex,e=r(-8,8),o=this.getHeading(t,1.8,3.14,20),p=map(o,0,20,18,-22)+e,c=map(o,0,20,.7,.5);c*=map(this.ix,0,16,1,.8),c*=2,sh.strokeWeight(c);let n=abs(this.points[t].cv.heading());(n<.5||n>2.9)&&(r(20,30),sh.stroke(0+p,r(10,15)),sh.line(i.x,i.y,h.x,h.y),sh.stroke(255+p,r(15,30)),sh.line(i.x,i.y+c,h.x,h.y+c))}avPoints(t,s){for(let i=0;i<t;i++){let t=[],i=[];for(let s=2;s<this.points.length-2;s++){let h=this.points[s].ex.copy().add(this.points[s-1].ex.copy()).add(this.points[s-2].ex.copy());h.div(3),t[s]=h.copy();let e=this.points[s].cv.copy().add(this.points[s-1].cv.copy()).add(this.points[s-2].cv.copy());e.div(3),i[s]=e.copy()}for(let h=2;h<this.points.length-2;h++){let e=this.points[h].cv.heading(),o=this.points[h-1].cv.heading(),r=this.points[h-2].cv.heading(),p=abs(e-(e+o+r)/3);0==this.points[h-1].tela&&0==this.points[h].tela&&p<s&&(this.points[h].ex=t[h],this.points[h].cv=i[h])}}}cleanup(){ft.smooth&&this.avPoints(1,1),this.edges=[];let t=0,s=r(1)<.6;for(let i=1;i<this.points.length-2;i++)(this.getAngle(i)>.05||1==i||i==this.points.length-3||isNaN(this.getAngle(i)))&&(this.points[i].tela?s?this.addEdge(t,i-1):this.addEdgeRand(t,i-1):s?this.addEdge(t,i):this.addEdgeRand(t,i),t=i);0==this.ix&&this.bookEnd()}sss(t,s,i){if(t>0&t<s){let h=p5.Vector.sub(this.p,i.p);h.normalize(),h.div(map(t,0,s,1,20)),this.ss[0].add(h),this.co[0]++}}aaa(t,s,i){t>0&t<s&&(this.ss[1].add(i.v),this.co[1]++)}ccc(t,s,i){t>0&t<s&&(this.ss[2].add(i.p),this.co[2]++)}ppp(){let t=createVector(0,0);this.v.add(this.sep.mult(this.sM)).add(this.ali.mult(this.aM)).add(this.coh.mult(this.cM)),this.v.limit(this.ms),t.add(this.v);let s=p5.Vector.dist(this.p,t);return this.clampRot(t,ft.rot,s)}clampRot(t,s,i){let h=round(map(t.heading(),-PI,PI,0,s)),e=p5.Vector.fromAngle(map(h,0,s,-PI,PI));return e.mult(i),e}genVectors(t){this.ss[0]=createVector(0,0),this.ss[1]=createVector(0,0),this.ss[2]=createVector(0,0),this.co[0]=this.co[1]=this.co[2]=0;for(let s=0;s<t.length;s++){let i=p5.Vector.dist(this.p,t[s].p);this.sss(i,this.sRo,t[s]),this.aaa(i,this.roi,t[s]),this.ccc(i,this.roi,t[s])}this.sep=this.co[0]>0?this.ss[0].div(this.co[0]).normalize().mult(this.ms).sub(this.v.copy()).limit(this.mf):this.ss[0],this.ali=this.co[1]>0?p5.Vector.sub(this.ss[1].div(this.co[1]).normalize().mult(this.ms),this.v.copy()).limit(this.mf):this.ss[1],this.coh=this.co[2]>0?p5.Vector.sub(p5.Vector.sub(this.ss[2].div(this.co[2]),this.p).normalize().mult(this.ms),this.v.copy()).limit(this.mf):this.ss[2],this.p.add(this.ppp().limit(this.ms))}borders(){if(this.bounce)this.p.x<bord.minX&&(this.v.x*=-1,this.p.x=bord.minX),this.p.y<bord.minX&&(this.v.y*=-1,this.p.y=bord.minY),this.p.x>bord.maxX&&(this.v.x*=-1,this.p.x=bord.maxX),this.p.y>bord.maxY&&(this.v.y*=-1,this.p.y=bord.maxY);else{if(this.p.x<bord.minX)return this.p.x=bord.maxX,!0;if(this.p.x>bord.maxX)return this.p.x=bord.minX,!0;if(this.p.y<bord.minY)return this.p.y=bord.maxY,!0;if(this.p.y>bord.maxY)return this.p.y=bord.minY,!0}return!1}getAngle(t){let s=p5.Vector.sub(this.points[t+1].cp,this.points[t].ex).normalize(),i=p5.Vector.sub(this.points[t].cp,this.points[t-1].ex).normalize();return abs(s.angleBetween(i))}addEdgeRand(t,s){this.edges.push({p1:this.points[t].ex,p2:this.points[s].ex,cv:this.points[t].cv,id:this.ix,cc:this.cc,zoom:r(1),ori:r(1),bsize:r(1)})}addEdge(t,s){this.edges.push({p1:this.points[t].ex,p2:this.points[s].ex,cv:this.points[t].cv,id:this.ix,cc:this.cc,zoom:this.zoom,ori:this.ori,bsize:this.bsize})}bookEnd(){this.edges.push({p1:createVector(bord.minX,bord.minY),p2:createVector(bord.maxX,bord.minY),cv:createVector(0,-1),id:this.ix,cc:pal.getBSK(),zoom:.2,ori:0,bsize:1}),this.edges.push({p1:createVector(bord.minX,bord.maxY),p2:createVector(bord.maxX,bord.maxY),cv:createVector(0,1),id:this.ix,cc:this.cc,zoom:1,ori:0,bsize:1})}}