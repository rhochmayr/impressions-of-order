class Scanline{constructor(){this.spoints=[]}scan(t){this.spoints=[];let e=createVector(t,0),i=createVector(t,1e3);for(let t=0;t<agents.length;t++)for(let s of agents[t].edges)if(this.doIntersect(s.p1,s.p2,e,i)&&abs(s.p1.x-s.p2.x)>10){let t=this.getPInt(s.p1,s.p2,e,i),y=map(dist(t.x,t.y,s.p1.x,s.p1.y),0,dist(s.p1.x,s.p1.y,s.p2.x,s.p2.y),0,1);this.spoints.push({xy:this.getPInt(s.p1,s.p2,e,i),cv:s.cv,id:s.id,cc:s.cc,zoom:s.zoom,ori:s.ori,bsize:s.bsize,along:y})}this.spoints.sort(((t,e)=>parseFloat(t.xy.y)-parseFloat(e.xy.y)))}thinLines(t){return{iC:(t.ori,ft.ori,4),mult:t.ori<ft.ori?.5:1,am:1.3}}midLines(t){return{iC:(t.ori,ft.ori,8),mult:(t.ori,ft.ori,2),am:1.3}}fatLines(t){return{iC:(t.ori,ft.ori,16),mult:(t.ori,ft.ori,4),am:1.2}}XLines(t){return{iC:(t.ori,ft.ori,32),mult:(t.ori,ft.ori,8),am:1.2}}lineFeatures(t){return t.zoom<.4&&0==getSuperSize()?this.thinLines(t):t.zoom<.7&&0==getSuperSize()||t.zoom<.2&&getSuperSize()?this.midLines(t):t.zoom<.6&&getSuperSize()?this.XLines(t):this.fatLines(t)}drawSL(t){for(let e=0;e<this.spoints.length-1;e++){let i=this.spoints[e],s=this.spoints[e+1],y=i.bsize<ft.dotThresh,o=i.cv.heading()+PI/2,x=abs(o-1.8),a=constrain(map(x,0,PI,20,0),0,20),n=map(a,0,20,30,-70);n=map(a,0,20,30,-60),n=map(a,0,20,pal.denMax,pal.denMin);let h=red(i.cc)+n,l=green(i.cc)+n,p=blue(i.cc)+n,m=map(i.xy.y,bord.minY,bord.maxY,0,pal.rShift),c=map(i.xy.x,bord.minX,bord.maxX,-pal.bShift,pal.bShift);h-=m+c,l-=m,p-=m-c/4;let d=this.lineFeatures(i);if(i.ori<ft.ori){if(t%d.iC==0){let t=pow(map(i.xy.y,bord.minY,bord.maxY,.2,1),2),e=t*random(pal.vmi,pal.vma),y=1+abs(i.cv.heading())*d.mult;sh.strokeWeight(y);let o=map(i.bsize,0,1,60,120);o=map(i.bsize,0,1,90,150),o*=pal.va,sh.stroke(h-30,l-30,p-20,35),sh.line(i.xy.x-1,i.xy.y,s.xy.x-1,s.xy.y),sh.stroke(h,l,p,1.2*o),abs(s.cv.heading())>3&&sh.stroke(h-4,l-6,p-7,1.2*o),sh.line(i.xy.x,i.xy.y,s.xy.x,s.xy.y),sh.stroke(h+e,l+e,p+e,.6*o),sh.line(i.xy.x,i.xy.y,s.xy.x,s.xy.y),s.xy.y-i.xy.y>160&&(sh.stroke(60,6),sh.line(s.xy.x,s.xy.y-30,s.xy.x,s.xy.y-0)),s.xy.y-i.xy.y>10&&(sh.stroke(h+15,l+5,p+r(5,8),o),sh.line(i.xy.x,i.xy.y,i.xy.x,i.xy.y+8*t))}}else{let e=y?ceil(4*d.mult):1,o=y?40:map(i.along,0,1,25,20);if(o=y?80:map(i.along,0,1,30,25),o=y?80:map(i.along,0,1,pal.hmaxA,pal.hminA),o*=pal.ha,t%e==0){let t=1+d.mult;if(sh.strokeWeight(t),0==isNaN(i.xy.y)){let t=floor(abs(i.xy.y-s.xy.y)),e=0;for(let y=0;y<t;y+=d.iC){let x=i.zoom<.99&&1==getVibration()?.7:.06;r(1)<.3&&(x=0),r(1)<.02&&(e=0);let a=ft.horiStep;sh.stroke(h,l,p,o),abs(s.cv.heading())>3&&sh.stroke(h-4,l-6,p-7,o),sh.line(i.xy.x,i.xy.y+y+e,i.xy.x,i.xy.y+(y+a)+e),s.xy.y-i.xy.y>160&&y>.8*t&&(sh.stroke(60,4),sh.line(i.xy.x,i.xy.y+y+e,i.xy.x,i.xy.y+(y+a)+(e+=random(-x,x)))),s.xy.y-i.xy.y>10&&(sh.stroke(h+n,l+n,p+n,o),sh.line(i.xy.x,i.xy.y+y+e+1,i.xy.x,i.xy.y+(y+a)+e+1));let m=pow(map(i.xy.y,bord.minY,bord.maxY,.2,1),2)*random(pal.hmi,pal.hma);sh.stroke(h-m,l-m,p-m,o+15),sh.line(i.xy.x,i.xy.y+y+e,i.xy.x,i.xy.y+(y+a)+(e+=random(-x,x)))}}}}}}onSeg(t,e,i){return e.x<=max(t.x,i.x)&&e.x>=min(t.x,i.x)&&e.y<=max(t.y,i.y)&&e.y>=min(t.y,i.y)}doIntersect(t,e,i,s){let y=this.ori(t,e,i),o=this.ori(t,e,s),r=this.ori(i,s,t),x=this.ori(i,s,e);return y!=o&&r!=x||!(0!=y||!this.onSeg(t,i,e))||!(0!=o||!this.onSeg(t,s,e))||!(0!=r||!this.onSeg(i,t,s))||!(0!=x||!this.onSeg(i,e,s))}ori(t,e,i){let s=(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y);return 0==s?0:s>0?1:2}getPInt(t,e,i,s){let y=e.y-t.y,o=t.x-e.x,r=y*t.x+o*t.y,x=s.y-i.y,a=i.x-s.x,n=x*i.x+a*i.y,h=y*a-x*o;return createVector((a*r-o*n)/h,(y*n-x*r)/h)}}